name: Security & Socket.IO Auth Scans

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '30 3 * * *' # Daily at 9:00 AM IST (03:30 UTC)
  workflow_dispatch:

jobs:
  security-scan:
    name: üîç Security & Auth Checks (OTS-RSK-00043 / OTS-RSK-00037)
    runs-on: ubuntu-latest

    env:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
      NVD_API_KEY: ${{ secrets.NVD_API_KEY }}

    steps:
      # -------------------------------
      # Setup
      # -------------------------------
      - name: üõ†Ô∏è Checkout repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: ‚öôÔ∏è Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety
          npm install -g snyk
          sudo apt-get update -y
          sudo apt-get install -y openjdk-17-jre-headless unzip wget curl jq

      # -------------------------------
      # OTS-RSK-00043 ‚Äî Vulnerable Dependencies
      # -------------------------------

      - name: üß© Run Snyk Dependency Scan (Non-blocking Mode)
        run: |
          snyk auth $SNYK_TOKEN
          echo "üîç Running Snyk scan (non-blocking mode)..."
          snyk test --severity-threshold=high || echo "‚ö†Ô∏è Snyk found high vulnerabilities (non-blocking mode)."

      - name: üêç Run Bandit (Python Security Scan)
        run: |
          bandit -r . -f txt -o bandit-report.txt || true

      # -------------------------------
      # Dependency-Check (Smart Fallback v12 ‚Üí v11)
      # -------------------------------
      - name: üõ°Ô∏è Install & Run OWASP Dependency-Check (Smart Fallback Mode)
        run: |
          echo "‚¨áÔ∏è Fetching latest OWASP Dependency-Check release..."
          sudo apt-get install -y jq

          LATEST_TAG=$(curl -s https://api.github.com/repos/jeremylong/DependencyCheck/releases/latest | jq -r .tag_name)
          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" = "null" ]; then
            echo "‚ö†Ô∏è Could not retrieve latest version, using fallback v12.1.0"
            LATEST_TAG="v12.1.0"
          fi

          FILE_NAME="dependency-check-${LATEST_TAG#v}-release.zip"
          DOWNLOAD_URL="https://github.com/jeremylong/DependencyCheck/releases/download/${LATEST_TAG}/${FILE_NAME}"

          echo "üì¶ Downloading from: $DOWNLOAD_URL"
          if ! wget -q --spider "$DOWNLOAD_URL"; then
            echo "‚ö†Ô∏è Latest version not found, using fallback v12.1.0"
            DOWNLOAD_URL="https://github.com/jeremylong/DependencyCheck/releases/download/v12.1.0/dependency-check-12.1.0-release.zip"
          fi

          wget "$DOWNLOAD_URL" -O dependency-check.zip
          unzip dependency-check.zip -d /opt/dependency-check
          echo "/opt/dependency-check/dependency-check/bin" >> $GITHUB_PATH
          ls -l /opt/dependency-check/dependency-check/bin

          echo "‚öôÔ∏è Running Dependency-Check (first attempt: v12.x, no-update mode)..."
          /opt/dependency-check/dependency-check/bin/dependency-check.sh \
            --project "${{ github.repository }}" \
            --scan . \
            --format "HTML" \
            --out dependency-check-report.html \
            --noupdate \
            || (
              echo "‚ö†Ô∏è v12.x failed (NVD feed bug). Retrying with stable v11.1.0..."
              wget -q https://github.com/jeremylong/DependencyCheck/releases/download/v11.1.0/dependency-check-11.1.0-release.zip -O dependency-check.zip
              unzip -o dependency-check.zip -d /opt/dependency-check-v11
              /opt/dependency-check-v11/dependency-check/bin/dependency-check.sh \
                --project "${{ github.repository }}" \
                --scan . \
                --format "HTML" \
                --out dependency-check-report.html \
                --noupdate \
                || echo "‚ö†Ô∏è Dependency-Check (v11 fallback) completed with warnings."
            )

      # -------------------------------
      # OTS-RSK-00037 ‚Äî Socket.IO Auth Validation
      # -------------------------------
      - name: üîí Validate Socket.IO Auth
        run: |
          echo "Checking for secure WebSocket (wss://) usage..."
          if grep -R "io(" -n . | grep -v "wss://"; then
            echo "‚ùå Insecure socket usage found (not using wss://)";
            exit 1;
          else
            echo "‚úÖ All socket connections use wss://";
          fi

          echo "Checking for token-based Socket.IO authentication..."
          if ! grep -R "token" -n . | grep -E "socket|auth"; then
            echo "‚ö†Ô∏è Token-based auth not explicitly detected, please review manually.";
          else
            echo "‚úÖ Token-based authentication references found.";
          fi

      # -------------------------------
      # Summary & Artifacts
      # -------------------------------
      - name: üßæ Summary of Security Checks
        run: |
          echo "---------------------------------------------"
          echo "üîç SECURITY SCAN SUMMARY"
          echo "---------------------------------------------"
          echo "‚úÖ Snyk Scan: Completed (non-blocking mode)"
          echo "‚úÖ Bandit Report: $(grep -c 'Issue:' bandit-report.txt || echo '0') issues found"
          echo "‚úÖ OWASP Dependency-Check: HTML report generated (with v12‚Üív11 fallback)"
          echo "‚úÖ Socket.IO Auth Check: Done"
          echo "---------------------------------------------"

      - name: üì§ Upload Security Reports
        uses: actions/upload-artifact@v4
        with:
          name: security-reports
          path: |
            bandit-report.txt
            dependency-check-report.html
