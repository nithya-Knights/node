name: üîê Secret Scanning (TruffleHog + Build Output Check)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  BUILD_DIR: dist        # Change to your frontend/backend build output directory
  EXCLUDE_PATHS: node_modules|.venv|venv|.git

jobs:
  secret-scan:
    name: Secret Scanning (TruffleHog + Regex)
    runs-on: ubuntu-latest

    steps:
      - name: üõ†Ô∏è Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: üì¶ Install TruffleHog
        run: |
          python -m pip install --upgrade pip
          pip install truffleHog

      - name: üîç TruffleHog - Filesystem scan
        run: |
          echo "Running TruffleHog filesystem scan..."
          trufflehog filesystem --exclude-paths "$EXCLUDE_PATHS" --max-filesize 500000 --json . | tee truffle_fs.json || true
          if grep -q '"stringsFound"' truffle_fs.json; then
            echo "::error ::TruffleHog found potential secrets in source files."
            exit 1
          fi

      - name: üîç TruffleHog - Git history scan
        run: |
          echo "Running TruffleHog git-history scan..."
          trufflehog git --json . | tee truffle_git.json || true
          if grep -q '"stringsFound"' truffle_git.json; then
            echo "::error ::TruffleHog found potential secrets in Git history."
            exit 1
          fi

      - name: üèóÔ∏è (Optional) Build project for artifact scan
        run: |
          if [ -f package.json ]; then
            echo "Building project to generate artifacts in $BUILD_DIR..."
            npm ci --silent
            npm run build --silent || true
          else
            echo "No package.json found. Skipping build step."
          fi

      - name: üîé TruffleHog - Scan build output
        run: |
          if [ -d "$BUILD_DIR" ]; then
            echo "Scanning build output: $BUILD_DIR"
            trufflehog filesystem --exclude-paths "$EXCLUDE_PATHS" --max-filesize 1000000 --json "$BUILD_DIR" | tee truffle_build.json || true
            if grep -q '"stringsFound"' truffle_build.json; then
              echo "::error ::TruffleHog found secrets in build output!"
              exit 1
            fi
          else
            echo "No build directory found ($BUILD_DIR). Skipping build scan."
          fi

      - name: üß† Regex-based secret checks (build output)
        run: |
          if [ -d "$BUILD_DIR" ]; then
            echo "Running regex checks for API keys and secrets..."
            found=false

            # AWS Access Key ID
            if grep -RIEn --exclude-dir={node_modules,.git,$EXCLUDE_PATHS} 'AKIA[0-9A-Z]{16}' "$BUILD_DIR"; then
              echo "::error ::Possible AWS Access Key found!"
              found=true
            fi

            # Google API Key
            if grep -RIEn --exclude-dir={node_modules,.git,$EXCLUDE_PATHS} 'AIza[0-9A-Za-z_\-]{35}' "$BUILD_DIR"; then
              echo "::error ::Possible Google API key found!"
              found=true
            fi

            # Private Key headers
            if grep -RIEn --exclude-dir={node_modules,.git,$EXCLUDE_PATHS} '-----BEGIN (RSA |EC )?PRIVATE KEY-----' "$BUILD_DIR"; then
              echo "::error ::Private key material detected!"
              found=true
            fi

            if [ "$found" = true ]; then
              echo "‚ùå Potential secrets found in build output."
              exit 1
            else
              echo "‚úÖ No secrets found in build output."
            fi
          else
            echo "Build directory not found; skipping regex scan."
          fi

      - name: üì§ Upload scan reports
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-reports
          path: |
            truffle_fs.json
            truffle_git.json
            truffle_build.json
