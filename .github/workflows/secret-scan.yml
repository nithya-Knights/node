name: üîê Secret Scanning (TruffleHog v3 + Build Output Check)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  BUILD_DIR: dist        # change if your frontend build folder is different
  EXCLUDE_PATHS: node_modules,.venv,venv,.git

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    name: TruffleHog + Regex Secret Scan

    steps:
      - name: üõ†Ô∏è Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: üì¶ Install latest TruffleHog (v3+)
        run: |
          python -m pip install --upgrade pip
          pip install "trufflehog>=3.63.7"

      - name: üîç TruffleHog - Filesystem scan (workspace)
        run: |
          echo "Running TruffleHog filesystem scan..."
          trufflehog filesystem --no-update --json . | tee truffle_fs.json || true
          if grep -q '"SourceMetadata"' truffle_fs.json; then
            echo "::error ::TruffleHog found potential secrets in source files."
            exit 1
          fi

      - name: üîç TruffleHog - Git history scan
        run: |
          echo "Running TruffleHog git-history scan..."
          trufflehog git --no-update --json . | tee truffle_git.json || true
          if grep -q '"SourceMetadata"' truffle_git.json; then
            echo "::error ::TruffleHog found potential secrets in Git history."
            exit 1
          fi

      - name: üèóÔ∏è Build project (optional)
        run: |
          if [ -f package.json ]; then
            echo "Building project..."
            npm ci --silent
            npm run build --silent || true
          else
            echo "No package.json found. Skipping build."
          fi

      - name: üîé TruffleHog - Scan build output
        run: |
          if [ -d "$BUILD_DIR" ]; then
            echo "Scanning build output in $BUILD_DIR ..."
            trufflehog filesystem --no-update --json "$BUILD_DIR" | tee truffle_build.json || true
            if grep -q '"SourceMetadata"' truffle_build.json; then
              echo "::error ::TruffleHog found secrets in build output!"
              exit 1
            fi
          else
            echo "No build directory found ($BUILD_DIR). Skipping."
          fi

      - name: üß† Regex-based secret check (build output)
        run: |
          if [ -d "$BUILD_DIR" ]; then
            echo "Running regex checks..."
            found=false

            # AWS Access Key
            if grep -RIEn --exclude-dir={$EXCLUDE_PATHS} 'AKIA[0-9A-Z]{16}' "$BUILD_DIR"; then
              echo "::error ::Possible AWS Access Key found!"
              found=true
            fi

            # Google API Key
            if grep -RIEn --exclude-dir={$EXCLUDE_PATHS} 'AIza[0-9A-Za-z_\-]{35}' "$BUILD_DIR"; then
              echo "::error ::Possible Google API Key found!"
              found=true
            fi

            # Private Key
            if grep -RIEn --exclude-dir={$EXCLUDE_PATHS} '-----BEGIN (RSA |EC )?PRIVATE KEY-----' "$BUILD_DIR"; then
              echo "::error ::Private key material found!"
              found=true
            fi

            if [ "$found" = true ]; then
              echo "‚ùå Potential secrets detected."
              exit 1
            else
              echo "‚úÖ No secrets found."
            fi
          else
            echo "Build directory not found; skipping regex scan."
          fi

      - name: üì§ Upload scan results
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: secret-scan-reports
          path: |
            truffle_fs.json
            truffle_git.json
            truffle_build.json
