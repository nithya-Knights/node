name: ESLint PHI in Storage Policy Check (OTS-RSK-00022)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  phi-storage-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      # ðŸ”’ Run only OTS-RSK-00022 custom rule (PHI in Storage)
      - name: Run ESLint (PHI in Storage Policy Only)
        id: eslintphi
        run: |
          echo "ðŸ” Running ESLint PHI in Storage policy check (OTS-RSK-00022)..."
          npx eslint . --ext .js,.ts,.tsx --no-eslintrc --rule '{"custom-rules/no-useStorage":"error"}' --plugin custom-rules || echo "violations=true" >> $GITHUB_OUTPUT
          echo "âœ… ESLint PHI policy check completed."

      # ðŸ“„ Generate Summary
      - name: Generate summary report
        if: always()
        run: |
          echo "## ðŸ§¾ OTS-RSK-00022 â€“ PHI in Storage Policy Check" >> $GITHUB_STEP_SUMMARY
          echo "- **Policy:** Detect \`useStorage()\` usage to prevent PHI persistence" >> $GITHUB_STEP_SUMMARY
          echo "- **Rule:** custom-rules/no-useStorage" >> $GITHUB_STEP_SUMMARY
          echo "- **Severity:** error (build fails if triggered)" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.eslintphi.outputs.violations }}" = "true" ]; then
            echo "- **Result:** âŒ Violations detected â€“ \`useStorage()\` found in code" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Result:** âœ… No PHI storage violations detected" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- **Completed at:** $(date)" >> $GITHUB_STEP_SUMMARY
