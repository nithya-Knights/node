name: FOSSA + SBOM Scan (feature/fossa-sbom)

on:
  push:
    branches: [ feature/fossa-sbom ]
  pull_request:
    branches: [ feature/fossa-sbom ]

jobs:
  fossa-sbom-scan:
    name: Generate SBOM & Run FOSSA Analysis
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------
      # 1Ô∏è‚É£ Checkout repository
      # -----------------------------------------------------------
      - name: üß© Checkout repository
        uses: actions/checkout@v4

      # -----------------------------------------------------------
      # 2Ô∏è‚É£ Setup Node.js
      # -----------------------------------------------------------
      - name: ‚öôÔ∏è Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: "npm"

      # -----------------------------------------------------------
      # 3Ô∏è‚É£ Install project dependencies
      # -----------------------------------------------------------
      - name: üì¶ Install dependencies
        run: |
          echo "Installing npm dependencies..."
          npm ci
          echo "‚úÖ Dependencies installed successfully"

      # -----------------------------------------------------------
      # 4Ô∏è‚É£ Generate SBOM (CycloneDX format)
      # -----------------------------------------------------------
      - name: üßæ Generate SBOM (CycloneDX)
        run: |
          echo "üîç Generating CycloneDX SBOM using Anchore Syft..."
          docker run --rm -v "${{ github.workspace }}":/project anchore/syft:latest dir:/project -o cyclonedx-json > sbom.cdx.json
          echo "‚úÖ SBOM generated: sbom.cdx.json"
          ls -lh sbom.cdx.json

      # -----------------------------------------------------------
      # 5Ô∏è‚É£ Upload SBOM as build artifact
      # -----------------------------------------------------------
      - name: üì§ Upload SBOM artifact
        uses: actions/upload-artifact@v4
        with:
          name: sbom-cyclonedx
          path: sbom.cdx.json

      # -----------------------------------------------------------
      # 6Ô∏è‚É£ Run FOSSA CLI analysis
      # -----------------------------------------------------------
      - name: üîç Run FOSSA scan and analysis
        uses: fossas/fossa-action@v2
        with:
          api_key: ${{ secrets.FOSSA_API_KEY }}

      # -----------------------------------------------------------
      # 7Ô∏è‚É£ Validate and print summary (optional)
      # -----------------------------------------------------------
      - name: üìä Validate SBOM structure
        run: |
          echo "Validating SBOM file..."
          head -n 20 sbom.cdx.json
          echo "‚úÖ SBOM validation complete"
