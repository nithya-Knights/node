name: FOSSA + SBOM Workflow (feature/fossa-sbom)

on:
  push:
    branches: [ feature/fossa-sbom ]
  pull_request:
    branches: [ feature/fossa-sbom ]

jobs:
  fossa-sbom-pipeline:
    name: Generate SBOM & FOSSA Analysis
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------
      # 1Ô∏è‚É£ Checkout repository
      # -----------------------------------------------------------
      - name: üß© Checkout source code
        uses: actions/checkout@v4

      # -----------------------------------------------------------
      # 2Ô∏è‚É£ Setup Node environment
      # -----------------------------------------------------------
      - name: ‚öôÔ∏è Setup Node.js (v18)
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      # -----------------------------------------------------------
      # 3Ô∏è‚É£ Install dependencies
      # -----------------------------------------------------------
      - name: üì¶ Install npm dependencies
        run: |
          echo "Installing dependencies..."
          npm ci
          echo "‚úÖ Installation complete"

      # -----------------------------------------------------------
      # 4Ô∏è‚É£ Generate CycloneDX SBOM using Syft
      # -----------------------------------------------------------
      - name: üßæ Generate SBOM with Anchore Syft
        run: |
          echo "üîç Generating SBOM..."
          docker run --rm -v "${{ github.workspace }}":/project anchore/syft:latest dir:/project -o cyclonedx-json > sbom.cdx.json
          echo "‚úÖ SBOM file created at $(pwd)/sbom.cdx.json"

      # -----------------------------------------------------------
      # 5Ô∏è‚É£ Upload SBOM artifact
      # -----------------------------------------------------------
      - name: üì§ Upload SBOM artifact to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: sbom-cyclonedx
          path: sbom.cdx.json

      # -----------------------------------------------------------
      # 6Ô∏è‚É£ Run FOSSA CLI Scan
      # -----------------------------------------------------------
      - name: üîç Run FOSSA dependency & license analysis
        uses: fossas/fossa-action@v1
        with:
          api-key: ${{ secrets.FOSSA_API_KEY }}

      # -----------------------------------------------------------
      # 7Ô∏è‚É£ Upload SBOM to FOSSA SBOM Import API
      # -----------------------------------------------------------
      - name: ‚òÅÔ∏è Upload SBOM to FOSSA dashboard
        env:
          FOSSA_API_KEY: ${{ secrets.FOSSA_API_KEY }}
        run: |
          echo "‚òÅÔ∏è Uploading CycloneDX SBOM to FOSSA API..."
          curl -s -o response.json -w "%{http_code}" \
            -X POST "https://app.fossa.com/api/projects/custom/upload" \
            -H "Authorization: token ${FOSSA_API_KEY}" \
            -F "name=nodejs-bookstore-api" \
            -F "format=cyclonedx" \
            -F "file=@sbom.cdx.json"
          echo "‚úÖ SBOM upload complete ‚Äî check your FOSSA dashboard under 'Imported SBOMs'"

      # -----------------------------------------------------------
      # 8Ô∏è‚É£ Display SBOM summary (optional)
      # -----------------------------------------------------------
      - name: üìä Display SBOM summary
        run: |
          echo "Top of SBOM file:"
          head -n 15 sbom.cdx.json
          echo "‚úÖ SBOM validation done"
