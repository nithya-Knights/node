name: Security & Compliance Checks

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ› ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      # -------------------------------------------------------
      # OTS-RSK-00031 - Legacy Libraries (moment.js detection)
      # -------------------------------------------------------
      - name: ğŸ” Legacy libraries (moment.js detection)
        run: |
          echo "ğŸ” Checking for legacy library: moment.js..."
          if grep -R "moment" package*.json; then
            echo "âŒ OTS-RSK-00031 FAILED: 'moment.js' detected. Replace with modern alternative (e.g., dayjs, date-fns)."
            exit 1
          else
            echo "âœ… OTS-RSK-00031 PASSED: No legacy libraries detected."
          fi

      - name: ğŸ” npm audit check
        run: |
          echo "ğŸ” Running npm audit..."
          npm audit --audit-level=moderate || (echo "âŒ npm audit found vulnerabilities"; exit 1)

      # -------------------------------------------------------
      # OTS-RSK-00022 - PHI in Storage (ESLint rule)
      # -------------------------------------------------------
      - name: ğŸ” Running ESLint PHI in Storage policy check (OTS-RSK-00022)
        run: |
          echo "ğŸ” Checking for useStorage() usage..."
          npx eslint . --ext .js,.ts,.vue --no-eslintrc \
            --rule '{"no-restricted-syntax":["error",{ "selector": "CallExpression[callee.name=\'useStorage\']", "message": "Detected useStorage() - possible PHI in storage (OTS-RSK-00022)" }]}' \
            || (echo "âŒ PHI storage rule failed"; exit 1)

      # -------------------------------------------------------
      # OTS-RSK-00034 - Secrets in Code
      # -------------------------------------------------------
      - name: ğŸ•µï¸ Secrets scanning with TruffleHog
        uses: trufflesecurity/trufflehog@v3.68.6
        with:
          scan: .
          fail: true

      # -------------------------------------------------------
      # OTS-RSK-00043 - Vulnerable Dependencies
      # -------------------------------------------------------
      - name: ğŸ§  Snyk vulnerability scan
        uses: snyk/actions/node@v1
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: --severity-threshold=medium

      # Optional: Dependency-Check (OWASP)
      - name: ğŸ§© Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: "NuxtFrontend"
          path: .
          format: "HTML"
          out: "./dependency-check-report"
