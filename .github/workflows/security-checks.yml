name: Security & Compliance Checks

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  security-scan:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ› ï¸ Checkout repository
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      # -------------------------------------------------------
      # OTS-RSK-00031 - Legacy Libraries (moment.js detection)
      # -------------------------------------------------------
      - name: ðŸ” Legacy libraries (moment.js detection)
        run: |
          echo "ðŸ” Checking for legacy library: moment.js..."
          if grep -R "moment" package*.json; then
            echo "âŒ OTS-RSK-00031 FAILED: 'moment.js' detected. Replace with modern alternative (e.g., dayjs, date-fns)."
            exit 1
          else
            echo "âœ… OTS-RSK-00031 PASSED: No legacy libraries detected."
          fi

      # -------------------------------------------------------
      # ðŸ”§ Auto-fix + npm audit check (OTS-RSK-00043)
      # -------------------------------------------------------
      - name: ðŸ”§ Attempt to auto-fix npm vulnerabilities
        run: |
          echo "ðŸ©¹ Running npm audit fix..."
          npm audit fix || echo "âš ï¸ Auto-fix did not resolve all vulnerabilities."

      - name: ðŸ”Ž npm audit check (fail if still vulnerable)
        run: |
          echo "ðŸ” Running npm audit..."
          npm audit --audit-level=moderate || (echo "âŒ npm audit found vulnerabilities"; exit 1)

      # ðŸ”’ Run only OTS-RSK-00022 custom rule (PHI in Storage)
      - name: Run ESLint (PHI in Storage Policy Only)
        id: eslintphi
        run: |
          echo "ðŸ” Running ESLint PHI in Storage policy check (OTS-RSK-00022)..."
          npx eslint . --ext .js,.ts,.tsx --no-eslintrc --rule '{"custom-rules/no-useStorage":"error"}' --plugin custom-rules || echo "violations=true" >> $GITHUB_OUTPUT
          echo "âœ… ESLint PHI policy check completed."
      # -------------------------------------------------------
      # OTS-RSK-00043 - Vulnerable Dependencies (Snyk)
      # -------------------------------------------------------
      - name: ðŸ§  Snyk vulnerability scan
        uses: snyk/actions/node@v1
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: test
          args: --severity-threshold=medium

      # -------------------------------------------------------
      # Optional: Dependency-Check (OWAS
